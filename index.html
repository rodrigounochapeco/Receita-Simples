<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Receituário de Controle Especial</title>

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --page-w: 210mm;
      --page-h: 296mm;

      --text-primary: #000000;
      --text-secondary: #3f3f46;
      --border-light: #e4e4e7;
      --border-input: #d4d4d8;
      --bg-paper: #ffffff;

      --font-main: 'Inter', sans-serif;

      --radius: 12px;
      --pauta-line: #cbd5e1;
      --pauta-height: 7.5mm;

      /* Respiro da prescrição (corrige “aperto” no fim) */
      --presc-pad-top: 1.5mm;
      --presc-pad-x: 5mm;
      --presc-pad-bottom: 7mm;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-main);
      background-color: #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 0;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    .paper-page {
      width: var(--page-w);
      height: var(--page-h);
      background-color: var(--bg-paper);
      padding: 12mm 15mm;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .layout-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .label-title {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 4px;
      letter-spacing: 0.03em;
      display: block;
    }

    .label-sm {
      font-size: 0.65rem;
      color: #666;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    input[type="text"] {
      font-family: var(--font-main);
      font-size: 11pt;
      color: var(--text-primary);
      font-weight: 500;
      background: transparent;
      border: none;
      width: 100%;
      padding: 2px 0;
      border-bottom: 1px solid transparent;
      outline: none;
    }

    .input-line { border-bottom: 1px solid var(--border-input) !important; }

    input:focus {
      border-bottom: 1px solid #000 !important;
      background-color: rgba(0,0,0,0.01);
    }

    ::placeholder { color: #9ca3af; font-weight: 400; }
    :focus::placeholder { color: transparent; }

    .rounded-box {
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 5mm;
      position: relative;
      margin-bottom: 4mm;
    }

    .box-label-float {
      position: absolute;
      top: -9px;
      left: 12px;
      background: #fff;
      padding: 0 6px;
      font-size: 0.8rem;
      font-weight: 800;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    /* Header */
    .top-header {
      position: relative;
      height: 20mm;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      margin-bottom: 2mm;
    }
    .main-title {
      font-size: 15pt;
      font-weight: 800;
      text-transform: uppercase;
      color: #111827;
      text-align: center;
      letter-spacing: -0.5px;
      margin-top: 2mm;
      z-index: 1;
    }
    .via-badge {
      position: absolute;
      bottom: 0;
      right: 0;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 1.5mm 3mm;
      font-size: 7.5pt;
      font-weight: 600;
      color: #555;
      text-transform: uppercase;
      background: #fff;
      z-index: 2;
    }

    /* Emitente */
    .issuer-grid { display: grid; gap: 3mm; }
    .row-group { display: flex; gap: 4mm; width: 100%; }
    .col { display: flex; flex-direction: column; }

    /* Corpo */
    .section-block { margin-bottom: 4mm; }

    /* Prescrição (WYSIWYG simples) */
    .prescription-area {
      flex: 1;
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
      margin-top: 2px;
      background: #fff;
    }

    .presc-editor {
      height: 100%;
      width: 100%;
      overflow: auto;

      padding: var(--presc-pad-top) var(--presc-pad-x) var(--presc-pad-bottom) var(--presc-pad-x);

      font-size: 11pt;
      line-height: var(--pauta-height);
      outline: none;

      white-space: pre-wrap;
      word-break: break-word;

      background-image: repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent calc(var(--pauta-height) - 1px),
        var(--pauta-line) calc(var(--pauta-height) - 1px),
        var(--pauta-line) var(--pauta-height)
      );
      background-attachment: local;
      background-position: 0 var(--presc-pad-top);
    }

    /* Evita margens estranhas quando colar HTML */
    .presc-editor :where(p, div, span, strong, b, em, i, u) { margin: 0; padding: 0; line-height: inherit; }

    /* Rodapé */
    .footer {
      height: 62mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      margin-top: 4mm;
    }

    .signature-area {
      display: flex;
      gap: 10mm;
      margin-bottom: 5mm;
      align-items: flex-end;
      height: 20mm;
    }

    .footer-cols { display: flex; gap: 4mm; height: 40mm; }
    .footer-box {
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 2mm 3mm;
      display: flex;
      flex-direction: column;
    }
    .footer-title {
      font-size: 6.5pt;
      font-weight: 800;
      text-align: center;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 2mm;
      padding-bottom: 1mm;
      color: var(--text-secondary);
    }

    /* GRID DO COMPRADOR */
    .buyer-grid {
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      height: 100%;
    }
    .buyer-row { display: flex; gap: 2mm; align-items: flex-end; margin-bottom: 0; }
    .buyer-label {
      font-weight: 700;
      color: #555;
      font-size: 8pt;
      white-space: nowrap;
      margin-right: 2px;
      margin-bottom: 2px;
    }
    .buyer-input {
      flex: 1;
      border-bottom: 1px solid #d4d4d8;
      height: 17px;
      font-size: 9pt;
      background: transparent;
      border-top: none; border-left: none; border-right: none;
      padding: 0 0 1px 0;
      line-height: normal;
      outline: none;
      font-family: var(--font-main);
      font-weight: 500;
    }

    /* Segunda via */
    .readonly-mode input, .readonly-mode .presc-editor { pointer-events: none; color: #444; }

    /* Controles (não imprimir) */
    .screen-controls {
      position: fixed; top: 20px; right: 20px; z-index: 999;
      background: #18181b; color: #fff; padding: 14px;
      border-radius: 10px; width: 260px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .controls-row { display: grid; gap: 8px; margin-top: 10px; }

    .btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }

    .btn-danger { background: #dc2626; color: #fff; }
    .btn-danger:hover { background: #b91c1c; }

    .btn-secondary { background: #27272a; color: #fff; border: 1px solid #3f3f46; }
    .btn-secondary:hover { background: #1f1f22; }

    .format-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 6px;
    }
    .btn-mini {
      padding: 9px 8px;
      border-radius: 6px;
      border: 1px solid #3f3f46;
      background: #111827;
      color: #fff;
      cursor: pointer;
      font-weight: 800;
    }
    .btn-mini:hover { background: #0b1220; }

    .btn[hidden] { display: none !important; }

    @media print {
      @page { size: A4; margin: 0; }
      body { background: none; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .screen-controls { display: none !important; }

      .paper-page {
        width: 210mm; height: 296mm; margin: 0;
        box-shadow: none; border: none; page-break-after: always;
        padding: 12mm 15mm;
      }
      .rounded-box, .via-badge, .footer-box, .prescription-area { border-color: #d1d5db !important; }
      ::placeholder { color: transparent; }
    }

    @media screen and (max-width: 800px) {
      .paper-page { transform: scale(0.45); transform-origin: top center; margin-bottom: -150mm; }
      .top-header { height: auto; padding-bottom: 30px; }
    }
  </style>
</head>

<body>
  <div class="screen-controls">
    <h4 style="margin-bottom: 10px;">Opções</h4>
    <small style="color:#a1a1aa;">Preencha a 1ª via. A 2ª via é automática.</small>

    <div class="controls-row">
      <button class="btn btn-primary" type="button" onclick="window.print()">
        <i class="fa-solid fa-print"></i> IMPRIMIR
      </button>

      <button class="btn btn-danger" id="btnClearAll" type="button">
        <i class="fa-solid fa-eraser"></i> LIMPAR TUDO
      </button>

      <button class="btn btn-secondary" id="btnSaveIssuer" type="button">
        <i class="fa-solid fa-floppy-disk"></i> SALVAR DADOS (EMITENTE)
      </button>

      <button class="btn btn-secondary" id="btnFillIssuer" type="button" hidden>
        <i class="fa-solid fa-wand-magic-sparkles"></i> PREENCHER DADOS SALVOS
      </button>

      <div style="margin-top:8px; font-size: 12px; color:#a1a1aa;">
        Formatação na prescrição (também funciona com Ctrl+B / Ctrl+I / Ctrl+U):
        <div class="format-row" style="margin-top:6px;">
          <button class="btn-mini" id="btnBold" type="button"><b>B</b></button>
          <button class="btn-mini" id="btnItalic" type="button"><i>I</i></button>
          <button class="btn-mini" id="btnUnderline" type="button"><u>U</u></button>
        </div>
      </div>
    </div>
  </div>

  <!-- VIA 1 -->
  <section class="paper-page" id="via1">
    <div class="layout-container">
      <div class="top-header">
        <div class="main-title">Receituário de Controle Especial</div>
        <div class="via-badge">1ª VIA - FARMÁCIA/DROGARIA</div>
      </div>

      <div class="rounded-box">
        <span class="box-label-float">Identificação do Emitente</span>

        <div class="issuer-grid">
          <div class="col">
            <span class="label-sm">Nome Completo do Profissional</span>
            <input type="text" class="input-sync autofit" data-field="emitente_nome"
                   placeholder="Nome do Médico Exemplo" style="font-weight: 600; font-size: 11pt;">
          </div>

          <div class="row-group">
            <div class="col" style="width: 100px;">
              <span class="label-sm">CRM</span>
              <input type="text" class="input-sync" data-field="emitente_crm" placeholder="00000">
            </div>

            <div class="col" style="width: 40px;">
              <span class="label-sm">UF</span>
              <input type="text" class="input-sync" data-field="emitente_uf" placeholder="SP">
            </div>

            <div style="width: 1px; background: #e5e7eb; margin: 4px 0;"></div>

            <div class="col" style="flex: 1;">
              <span class="label-sm">Endereço Completo e Telefone</span>
              <input type="text" class="input-sync" data-field="emitente_end" placeholder="Av. Exemplo, 123 - (11) 9999-9999">
            </div>
          </div>

          <div class="col">
            <span class="label-sm">Cidade</span>
            <input type="text" class="input-sync" data-field="emitente_cidade" placeholder="São Paulo">
          </div>
        </div>
      </div>

      <div class="section-block">
        <span class="label-title">Paciente</span>
        <input type="text" class="input-sync input-line" data-field="paciente_nome">
      </div>

      <div class="section-block" style="margin-top: -2mm;">
        <span class="label-title">Endereço</span>
        <input type="text" class="input-sync input-line" data-field="paciente_end">
      </div>

      <div style="margin-top: 2mm;">
        <span class="label-title">Prescrição</span>
      </div>

      <div class="prescription-area">
        <!-- Editor rico (sem markdown) -->
        <div class="presc-editor input-sync" data-field="prescricao" contenteditable="true" spellcheck="false"></div>
      </div>

      <div class="footer">
        <div class="signature-area">
          <div style="width: 30%;">
            <span class="label-title" style="font-weight: 700; font-size: 0.7rem;">Data</span>
            <input type="text" class="input-sync input-line" data-field="data" style="text-align: center;">
          </div>

          <div style="flex: 1; text-align: center;">
            <div style="border-top: 1px solid #000; padding-top: 2px;">
              <span class="label-title" style="font-weight: 600; font-size: 0.7rem;">Assinatura e Carimbo do Médico</span>
            </div>
          </div>
        </div>

        <div class="footer-cols">
          <div class="footer-box" style="flex: 1.4;">
            <div class="footer-title">IDENTIFICAÇÃO DO COMPRADOR</div>
            <div class="buyer-grid">
              <div class="buyer-row">
                <span class="buyer-label">Nome:</span>
                <!-- Auto-fit aqui -->
                <input class="buyer-input autofit" data-autofit-min="8" type="text">
              </div>
              <div class="buyer-row">
                <span class="buyer-label">Ident:</span>
                <input class="buyer-input" type="text" style="flex:1">
                <span class="buyer-label" style="margin-left: 5px;">Org:</span>
                <input class="buyer-input" type="text" style="width: 40px; flex:none;">
              </div>
              <div class="buyer-row">
                <span class="buyer-label">End:</span>
                <input class="buyer-input" type="text">
              </div>
              <div class="buyer-row">
                <span class="buyer-label">Cid:</span>
                <input class="buyer-input" type="text" style="flex:2">
                <span class="buyer-label" style="margin-left: 5px;">UF:</span>
                <input class="buyer-input" type="text" style="width: 25px; flex:none;">
                <span class="buyer-label" style="margin-left: 5px;">Tel:</span>
                <input class="buyer-input" type="text" style="flex:1.5">
              </div>
            </div>
          </div>

          <div class="footer-box" style="flex: 1;">
            <div class="footer-title">IDENTIFICAÇÃO DO FORNECEDOR</div>
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #d4d4d8;">
              <small>(Carimbo da Farmácia)</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- VIA 2 (Espelho) -->
  <section class="paper-page readonly-mode" id="via2">
    <div class="layout-container">
      <div class="top-header">
        <div class="main-title">Receituário de Controle Especial</div>
        <div class="via-badge">2ª VIA - PACIENTE</div>
      </div>

      <div class="rounded-box">
        <span class="box-label-float">Identificação do Emitente</span>

        <div class="issuer-grid">
          <div class="col">
            <span class="label-sm">Nome Completo do Profissional</span>
            <input type="text" data-target="emitente_nome" style="font-weight: 600;">
          </div>

          <div class="row-group">
            <div class="col" style="width: 100px;">
              <span class="label-sm">CRM</span>
              <input type="text" data-target="emitente_crm">
            </div>

            <div class="col" style="width: 40px;">
              <span class="label-sm">UF</span>
              <input type="text" data-target="emitente_uf">
            </div>

            <div style="width: 1px; background: #e5e7eb; margin: 4px 0;"></div>

            <div class="col" style="flex: 1;">
              <span class="label-sm">Endereço Completo e Telefone</span>
              <input type="text" data-target="emitente_end">
            </div>
          </div>

          <div class="col">
            <span class="label-sm">Cidade</span>
            <input type="text" data-target="emitente_cidade">
          </div>
        </div>
      </div>

      <div class="section-block">
        <span class="label-title">Paciente</span>
        <input type="text" class="input-line" data-target="paciente_nome">
      </div>

      <div class="section-block" style="margin-top: -2mm;">
        <span class="label-title">Endereço</span>
        <input type="text" class="input-line" data-target="paciente_end">
      </div>

      <div style="margin-top: 2mm;">
        <span class="label-title">Prescrição</span>
      </div>

      <div class="prescription-area">
        <div class="presc-editor" data-target="prescricao" contenteditable="false" spellcheck="false"></div>
      </div>

      <div class="footer">
        <div class="signature-area">
          <div style="width: 30%;">
            <span class="label-title" style="font-weight: 700; font-size: 0.7rem;">Data</span>
            <input type="text" class="input-line" data-target="data" style="text-align: center;">
          </div>

          <div style="flex: 1; text-align: center;">
            <div style="border-top: 1px solid #000; padding-top: 2px;">
              <span class="label-title" style="font-weight: 600; font-size: 0.7rem;">Assinatura e Carimbo do Médico</span>
            </div>
          </div>
        </div>

        <div class="footer-cols">
          <div class="footer-box" style="flex: 1.4;">
            <div class="footer-title">IDENTIFICAÇÃO DO COMPRADOR</div>
          </div>

          <div class="footer-box" style="flex: 1;">
            <div class="footer-title">IDENTIFICAÇÃO DO FORNECEDOR</div>
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #d4d4d8;">
              <small>(Carimbo da Farmácia)</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const STORAGE_KEY = 'receituario.emitente.v1';
      const ISSUER_FIELDS = ['emitente_nome', 'emitente_crm', 'emitente_uf', 'emitente_end', 'emitente_cidade'];

      const $  = (sel, ctx = document) => ctx.querySelector(sel);
      const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

      // ===== Data padrão =====
      const dateField = $('[data-field="data"]');
      if (dateField && !dateField.value) dateField.value = new Date().toLocaleDateString('pt-BR');

      // ===== Sync (inputs + editor richtext) =====
      const syncSources = $$('.input-sync');

      function syncToMirror(sourceEl) {
        const fieldName = sourceEl.getAttribute('data-field');
        const target = document.querySelector(`[data-target="${fieldName}"]`);
        if (!target) return;

        const isRich = sourceEl.classList.contains('presc-editor') && sourceEl.isContentEditable;
        if (isRich) {
          target.innerHTML = sourceEl.innerHTML;
          target.scrollTop = sourceEl.scrollTop;
        } else {
          target.value = sourceEl.value;
        }
      }

      syncSources.forEach(el => {
        el.addEventListener('input', () => syncToMirror(el));
      });

      // Prescrição: scroll espelhado
      (function setupPrescriptionScrollSync() {
        const editor1 = $('#via1 .presc-editor[data-field="prescricao"]');
        const editor2 = $('#via2 .presc-editor[data-target="prescricao"]');
        if (!editor1 || !editor2) return;

        editor1.addEventListener('scroll', () => {
          editor2.scrollTop = editor1.scrollTop;
        });
      })();

      // Dispara sync inicial
      syncSources.forEach(el => el.dispatchEvent(new Event('input', { bubbles: true })));

      // ===== Auto-fit de fonte em inputs =====
      const _fitCanvas = document.createElement('canvas');
      const _fitCtx = _fitCanvas.getContext('2d');

      function fitTextToInput(input) {
        const style = getComputedStyle(input);
        const maxPx = parseFloat(style.fontSize) || 12;
        const minPx = parseFloat(input.dataset.autofitMin || '') || Math.max(8, maxPx * 0.7);

        // reset
        input.style.fontSize = `${maxPx}px`;

        const fontFamily = style.fontFamily;
        const fontWeight = style.fontWeight;

        const value = input.value || input.placeholder || '';
        const padL = parseFloat(style.paddingLeft) || 0;
        const padR = parseFloat(style.paddingRight) || 0;
        const available = Math.max(0, input.clientWidth - padL - padR - 2);

        let size = maxPx;
        while (size > minPx) {
          _fitCtx.font = `${fontWeight} ${size}px ${fontFamily}`;
          const w = _fitCtx.measureText(value).width;
          if (w <= available) break;
          size -= 0.25;
        }
        input.style.fontSize = `${size}px`;
      }

      function setupAutofit() {
        const autofits = $$('.autofit');
        autofits.forEach(el => {
          const handler = () => fitTextToInput(el);
          el.addEventListener('input', handler);
          window.addEventListener('resize', handler);
          handler();
        });
      }
      setupAutofit();

      // ===== Prescrição: clicar em qualquer linha =====
      function placeCaretAtEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }

      function getLineCountApprox(editor) {
        // Aproxima por quebras de linha do texto (Enter). Para “linhas vazias”, a lógica abaixo adiciona <br>.
        const t = (editor.innerText || '').replace(/\u00A0/g, ''); // nbsp
        const lines = t.split('\n');
        return Math.max(1, lines.length);
      }

      (function setupClickToLine() {
        const editor = $('#via1 .presc-editor[data-field="prescricao"]');
        if (!editor) return;

        editor.addEventListener('mousedown', (e) => {
          // Só “força linha” quando clica abaixo do conteúdo atual
          const cs = getComputedStyle(editor);
          const lineHeight = parseFloat(cs.lineHeight) || 18;
          const padTop = parseFloat(cs.paddingTop) || 0;

          const y = e.offsetY + editor.scrollTop - padTop;
          const clickedLine = Math.max(0, Math.floor(y / lineHeight));

          const currentLineCount = getLineCountApprox(editor);

          if (clickedLine >= currentLineCount) {
            e.preventDefault();

            const need = clickedLine - currentLineCount + 1;

            placeCaretAtEnd(editor);
            for (let i = 0; i < need; i++) {
              // Insere quebra de linha “real” no contenteditable
              document.execCommand('insertHTML', false, '<br>');
            }

            // dispara sync
            editor.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
      })();

      // ===== Formatação (B/I/U) =====
      function focusPrescription() {
        const editor = $('#via1 .presc-editor[data-field="prescricao"]');
        if (editor) editor.focus();
        return editor;
      }

      function applyFormat(cmd) {
        const editor = focusPrescription();
        if (!editor) return;
        document.execCommand(cmd, false, null);
        editor.dispatchEvent(new Event('input', { bubbles: true }));
      }

      $('#btnBold')?.addEventListener('click', () => applyFormat('bold'));
      $('#btnItalic')?.addEventListener('click', () => applyFormat('italic'));
      $('#btnUnderline')?.addEventListener('click', () => applyFormat('underline'));

      // ===== Botão: Limpar tudo =====
      $('#btnClearAll')?.addEventListener('click', () => {
        const via1 = document.getElementById('via1');
        if (!via1) return;

        via1.querySelectorAll('input[type="text"]').forEach(el => {
          el.value = '';
          el.style.fontSize = '';
        });

        const editor = $('#via1 .presc-editor[data-field="prescricao"]');
        if (editor) editor.innerHTML = '';

        // reatribui data atual
        if (dateField) dateField.value = new Date().toLocaleDateString('pt-BR');

        // re-sync
        syncSources.forEach(el => el.dispatchEvent(new Event('input', { bubbles: true })));

        // recalcula autofit
        $$('.autofit').forEach(fitTextToInput);
      });

      // ===== Salvar/Preencher Emitente (localStorage) =====
      function getIssuerDataFromForm() {
        const data = {};
        ISSUER_FIELDS.forEach(k => {
          const el = $(`#via1 [data-field="${k}"]`);
          data[k] = (el?.value ?? '').trim();
        });
        return data;
      }

      function fillIssuerData(data) {
        ISSUER_FIELDS.forEach(k => {
          const el = $(`#via1 [data-field="${k}"]`);
          if (el && typeof data?.[k] === 'string') el.value = data[k];
        });

        ISSUER_FIELDS.forEach(k => {
          const el = $(`#via1 [data-field="${k}"]`);
          el?.dispatchEvent(new Event('input', { bubbles: true }));
        });

        $$('.autofit').forEach(fitTextToInput);
      }

      function loadSavedIssuer() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      const btnSaveIssuer = $('#btnSaveIssuer');
      const btnFillIssuer = $('#btnFillIssuer');

      btnSaveIssuer?.addEventListener('click', () => {
        const data = getIssuerDataFromForm();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        if (btnFillIssuer) btnFillIssuer.hidden = false;

        const old = btnSaveIssuer.innerHTML;
        btnSaveIssuer.innerHTML = '<i class="fa-solid fa-check"></i> SALVO';
        setTimeout(() => (btnSaveIssuer.innerHTML = old), 900);
      });

      btnFillIssuer?.addEventListener('click', () => {
        const saved = loadSavedIssuer();
        if (saved) fillIssuerData(saved);
      });

      // Sugere preencher ao abrir
      (function initSavedIssuerSuggestion() {
        const saved = loadSavedIssuer();
        if (!saved) return;

        const allEmpty = ISSUER_FIELDS.every(k => {
          const el = $(`#via1 [data-field="${k}"]`);
          return !el || !el.value.trim();
        });

        if (allEmpty) {
          fillIssuerData(saved);
        } else {
          if (btnFillIssuer) btnFillIssuer.hidden = false;
        }
      })();
    });
  </script>
</body>
</html>
